const story = {
    // === ДЕНЬ 1 ===
    start: [
        { type: 'setDay', day: 1 },
        { type: 'setBg', bg: 'bg-room' },
        { type: 'playMusic', file: 'room' },
        { type: 'hideChars' },
        { type: 'dialogue', speaker: '', text: 'Вокруг лишь тьма. Она одна в этом мире, рядом никого нет. Сознание цепляется за разные воспоминания и ощущения, но цельной картины получить не удаётся. Она слышит обрывки тяжёлого драконьего дыхания. Свист ветра, лязг металла о чешую — всё это так далеко!' },
        { type: 'dialogue', speaker: '', text: 'Кто-то тронул её за плечо. Она проснулась в небольшом деревянном доме. Над ней нависал кот с разноцветными глазами. Он усердно продолжал пихать её в плечо. Она недовольно вздохнула и села прямо. Половицы скрипнули под лапами.' },
        { type: 'showChar', pos: 'left', name: 'khvoynik', mood: 'neutral' },
        { type: 'showChar', pos: 'right', name: 'nora', mood: 'neutral' },
        { type: 'dialogue', speaker: 'Хвойник', mood: 'neutral', text: '— Ты сколько ещё спать собираешься? Совсем вчера на тренировке вымоталась?' },
        { type: 'dialogue', speaker: '', text: 'Предрассветная Мгла зевнула, потянулась и вздохнула с такой усталостью, будто на её плечах вес всего архипелага.'},
        { type: 'dialogue', speaker: 'Предрассветная Мгла', mood: 'neutral', text: '— Ты даже не представляешь насколько. Сварт вчера совсем непослушным был, поводий не слушался. Зачем было меня так рано будить?' },
        { type: 'dialogue', speaker: 'Хвойник', mood: 'happy', text: '— Ага, потом поблагодаришь. Сегодня соревнование всадников! Ух, там столько всего заготовили, столько шума вокруг этого.' },
        { type: 'dialogue', speaker: 'Предрассветная Мгла', mood: 'happy', text: '— Соревнование?! Сегодня?!' },
        { type: 'dialogue', speaker: 'Хвойник', mood: 'happy', text: '— Конечно, как ты могла это забыть? Слушай дальше. Будет серия испытаний. Победитель всего один, он и получит звание “Лучшего укротителя драконов”. Ну, и там что-то ещё обещали…' },
        { type: 'dialogue', speaker: '', text: 'Предрассветная Мгла резко оживляется и поднимается с кровати.'},
        { type: 'dialogue', speaker: 'Предрассветная Мгла', mood: 'happy', text: '— Говори, Хвойник, где будет первое испытание? Мне нужно узнать больше! Ставлю своё кольцо, что я буду первой во всех испытаниях. Могу тебя взять в качестве поддержки, чтобы обидно не было.' },
        { type: 'dialogue', speaker: 'Хвойник', mood: 'happy', text: '— Ну-ну, полетела она… Идём за мной на площадь! Там тебя уже драконы ждут.' },
        { type: 'jump', to: 'dragon_selection_intro' }
    ],

    dragon_selection_intro: [
        { type: 'setBg', bg: 'bg-square' },
        { type: 'playMusic', file: 'arena' },
        { type: 'hideChars' },
        { type: 'action', func: 'showAllDragonsForChoice' }, // Показываем всех трех драконов
        { type: 'dialogue', speaker: '', text: 'Площадь была залита ярким солнечным светом. Далёкие волны разбивались о скалы, птицы шумели вокруг. В центре стояли три дракона. Они переминались с лапы на лапу и нетерпеливо били себя хвостами по бокам.' },
        { type: 'dialogue', speaker: '', text: 'Первой была красивая Ночная фуррия. Она вертела головой из стороны в сторону, чёрная чешуя переливалась на солнце. Правый глаз светил алым цветом, второй глаз отдавал ярко-фиолетовым. Она с интересом смотрела на свою потенциальную наездницу, гибкое тело уже было готово ринуться в полёт.' },
        { type: 'dialogue', speaker: '', text: 'Второй была Песня Смерти. Её крылья были широко раскрыты, причудливые синие узоры завораживали взгляд, острые тонкие клыки торчали из пасти. Перепончатые уши колыхались на ветре. Непокорный дракон словно не проявлял к наезднице никакого интереса.' },
        { type: 'dialogue', speaker: '', text: 'Третьим на земле беззаботно валялся Громобой и будто улыбался всеми рядами зубов. Узкие зрачки смотрели на других драконов. Похожий был у Стоика. Мощный и верный, но за ним нужно тщательно следить.' },
        { type: 'choice', options: [
            { text: 'Ночная Фурия', jumpTo: 'pick_dragon', params: 'fury' },
            { text: 'Песня Смерти', jumpTo: 'pick_dragon', params: 'death' },
            { text: 'Громобой', jumpTo: 'pick_dragon', params: 'thunder' }
        ]}
    ],

    pick_dragon: [
        { type: 'action', func: 'pickDragon' },
        { type: 'hideChars' }, { type: 'setBg', bg: 'bg-square' },
        { type: 'showChar', pos: 'center', name: 'dragon', mood: 'neutral' }, // Дракон по центру
        { type: 'showChar', pos: 'right', name: 'nora', mood: 'happy' },
        { type: 'showChar', pos: 'left', name: 'khvoynik', mood: 'neutral' },
        { type: 'eval', code: `
            if (engine.state.dragon === 'fury') engine.jumpTo('pick_fury_dialogue');
            else if (engine.state.dragon === 'death') engine.jumpTo('pick_death_dialogue');
            else engine.jumpTo('pick_thunder_dialogue');
        `}
    ],
    pick_fury_dialogue: [{ type: 'dialogue', speaker: 'Хвойник', mood: 'neutral', text: '— Любишь себе лучших забирать? Чтобы остальные плелись за тобой хвостом? Смотри, он весьма непросто управляется. Желаю удачи с этим.' }, { type: 'jump', to: 'feeding_intro' }],
    pick_death_dialogue: [{ type: 'dialogue', speaker: 'Хвойник', mood: 'neutral', text: '— Непокорная и смертоносно прекрасная. Тяжело будет совладать с ней, она с характером! Говорят, таких с самого рождения приручают…' }, { type: 'jump', to: 'feeding_intro' }],
    pick_thunder_dialogue: [{ type: 'dialogue', speaker: 'Хвойник', mood: 'happy', text: '— Ох, мой любимчик! Не такой быстрый, но зато всех снесёт на своём пути! И верный какой, глянь как на тебя уже смотрит!' }, { type: 'jump', to: 'feeding_intro' }],

    feeding_intro: [
        { type: 'dialogue', speaker: 'Хвойник', mood: 'neutral', text: '— Выбрала? Отлично! Теперь дракона нужно расположить к себе. А что есть главный путь к сердцу дракона? Верно, желудок! Дракона нужно прикормить. Сегодня даётся две попытки прикормки.' },
        { type: 'dialogue', speaker: 'Предрассветная Мгла', mood: 'neutral', text: '— Знаю я, не первый день вожусь с драконами. А чем кормить?' },
        { type: 'dialogue', speaker: 'Хвойник', mood: 'neutral', text: '— Всё нужное тебе выдадут! Только смотри, выбирай с умом. Дракон и обидеться может, и тогда не жди, что он будет каждую твою команду слушать.' },
        { type: 'jump', to: 'feeding_loop' }
    ],
    feeding_loop: [
        { type: 'playMusic', file: 'field' },
        { type: 'setBg', bg: 'bg-field' },
        { type: 'hideChars' },
        { type: 'action', func: 'showDragonSolo' }, // ТОЛЬКО дракон, как просил
        { type: 'eval', code: `if (engine.state.feedCount >= 2) engine.jumpTo('post_feeding_dialogue');` },
        { type: 'dialogue', speaker: '', text: 'Попытка кормления №{feedCount+1}. Что вы предложите дракону?' },
        { type: 'choice', options: [
            { text: 'Свежий лосось', jumpTo: 'feed_result', params: 'fish' }, 
            { text: 'Жареная курица', jumpTo: 'feed_result', params: 'chicken' },
            { text: 'Черствый хлеб', jumpTo: 'feed_result', params: 'bread' }, 
            { text: 'Медовые соты', jumpTo: 'feed_result', params: 'honey' },
            { text: 'Копченый угорь', jumpTo: 'feed_result', params: 'eel' }, 
            { text: 'Гладкие камни', jumpTo: 'feed_result', params: 'rocks' }
        ]}
    ],
    feed_result: [
        { type: 'action', func: 'processFeed' },
        { type: 'eval', code: `
            const pref = engine.lastFeedPref;
            if (pref === 1) {
                if(engine.state.feedCount === 1) engine.jumpTo('feed_good1');
                else engine.jumpTo('feed_good2');
            } else if (pref === -1) {
                if(engine.state.feedCount === 1) engine.jumpTo('feed_bad1');
                else engine.jumpTo('feed_bad2');
            } else {
                engine.jumpTo('feed_neutral');
            }
        `}
    ],
    feed_good1: [{ type: 'dialogue', speaker: '', text: 'Дракон меняется, попробовав вашу прикормку. Его зрачки чуть расширились, но он всё ещё остаётся напряжённым рядом с вами.' }, { type: 'jump', to: 'feeding_loop' }],
    feed_good2: [{ type: 'dialogue', speaker: '', text: 'Дракон полностью доволен вами. Он больше не смотрит на вас так настороженно, поза расслабленная. Вы заслужили его расположение.' }, { type: 'jump', to: 'feeding_loop' }],
    feed_bad1: [{ type: 'dialogue', speaker: '', text: 'Зрачки дракона сузились, лапы напряглись, хвост стал неподвижным. Теперь он внимательно следит за каждым вашим движением, выражая своё недоверие, но всё ещё может измениться.' }, { type: 'jump', to: 'feeding_loop' }],
    feed_bad2: [{ type: 'dialogue', speaker: '', text: 'Это дракону явно не понравилось! Он обнажает клыки и зло смотрит на вас. Ясно одно: он будет слушаться, потому что ему прикажут, а не потому что он вам доверяет.' }, { type: 'jump', to: 'feeding_loop' }],
    feed_neutral: [{ type: 'dialogue', speaker: '', text: 'Дракон съел это без энтузиазма. Кажется, он ожидал чего-то другого.' }, { type: 'jump', to: 'feeding_loop' }],

    post_feeding_dialogue: [
        { type: 'setBg', bg: 'bg-room' }, 
        { type: 'playMusic', file: 'room' },
        { type: 'hideChars' },
        { type: 'showChar', pos: 'left', name: 'khvoynik', mood: 'neutral' }, 
        { type: 'showChar', pos: 'right', name: 'nora', mood: 'neutral' },
        { type: 'dialogue', speaker: 'Хвойник', mood: 'neutral', text: '— Снова привет, пришёл проведать тебя. Как успехи? Уже готовишься расстаться со своим кольцом?' },
        { type: 'eval', code: `
            if (engine.state.mood >= 2) engine.jumpTo('post_feed_good');
            else if (engine.state.mood <= -1) engine.jumpTo('post_feed_bad');
            else engine.jumpTo('post_feed_neutral');
        `},
    ],
    post_feed_good: [ 
        { type: 'dialogue', speaker: 'Предрассветная Мгла', mood: 'happy', text: '— Ошибаешься! Смотри, как ему хорошо, какой он довольный! Завтра точно будет меня слушаться.' }, 
        { type: 'dialogue', speaker: 'Хвойник', mood: 'neutral', text: '— А ты уверена, что не перекормила его? Вдруг он завтра вообще откажется лететь?..' }, 
        { type: 'jump', to: 'day1_end' }
    ],
    post_feed_bad: [ 
        { type: 'dialogue', speaker: 'Предрассветная Мгла', mood: 'neutral', text: '— Даже не начинай. Как бы я ни пыталась, ничего не получается. Он весь обозлился на меня, в угол забился. Не знаю, что с ним делать…' }, 
        { type: 'dialogue', speaker: 'Хвойник', mood: 'neutral', text: '— Ого, плохо дело! Может быть, ещё полюбит тебя? Уверен, ты что-нибудь придумаешь!' }, 
        { type: 'jump', to: 'day1_end' }
    ],
    post_feed_neutral: [ 
        { type: 'dialogue', speaker: 'Предрассветная Мгла', mood: 'neutral', text: '— Не знаю. Ему вроде понравилось, а вроде и нет. Смотрит на меня с какой-то настороженностью. Утром посмотрим, вдруг он просто спать хочет…' }, 
        { type: 'dialogue', speaker: 'Хвойник', mood: 'neutral', text: '— Да, он словно совсем такой же, каким ты его взяла с площади. Не знает, что от тебя ожидать. Ну, непредсказуемость — тоже сила.' }, 
        { type: 'jump', to: 'day1_end' }
    ],
    day1_end: [
        { type: 'dialogue', speaker: 'Хвойник', mood: 'neutral', text: '— Хорошо, продолжай готовить своего дракона. Не засиживайся допоздна, я тебя завтра будить уже не стану!' },
        { type: 'dialogue', speaker: 'Предрассветная Мгла', mood: 'neutral', text: '— Не буду, спасибо. Доброй ночи!' },
        { type: 'dialogue', speaker: 'Хвойник', mood: 'neutral', text: '— Доброй ночи!' },
        { type: 'stopMusic' },
        { type: 'transition', text: 'На следующий день...', to: 'day2_start' }
    ],

    // === ДЕНЬ 2 ===
    day2_start: [
        { type: 'setDay', day: 2 }, { type: 'setBg', bg: 'bg-room' }, { type: 'playMusic', file: 'room' }, { type: 'hideChars' },
        { type: 'dialogue', speaker: '', text: 'Снова эта тьма, словно она никогда отсюда не уходила. Внутри дрожь, волнение захлёстывает изнутри. А что если она выбрала неправильно? Могла ли она справиться лучше? Ответ неизвестен, и от этого на душе было ещё хуже.' },
        { type: 'dialogue', speaker: '', text: 'Предрассветная Мгла открыла глаза. Не спится. В голове мелькают разные сюжеты. Вот она верхом на своём драконе пересекает финишную черту, все остальные позади, толпа ликует! Ей вручают приз, она сделала это, она лучше всех!' },
        { type: 'dialogue', speaker: '', text: 'А если проиграет? Что тогда? Значит, она не справилась, провалилась как наездница и дрессировщик. С другой стороны, ей не нравились сами условия, в которые её загнали правилами соревнований. Вы должны быть с драконом одним целом, понимать друг друга с любого жеста, доверять без оглядки. На это уходят дни, месяцы, годы тренировок! А тут даётся всего три дня... Да, драконы уже объезженные, они не боятся седла, но доверяет ли её действиям эта чешуйчатая туша, которая спит возле дома?' },
        { type: 'dialogue', speaker: '', text: 'Утром к ней заходит Хвойник в приподнятом настроении. Он не может сдержать улыбки. Видимо, у него всё идёт хорошо.'},
        { type: 'showChar', pos: 'left', name: 'khvoynik', mood: 'happy' }, 
        { type: 'showChar', pos: 'right', name: 'nora', mood: 'neutral' },
        { type: 'dialogue', speaker: 'Хвойник', mood: 'happy', text: '— Ну как дела, полуночница? Выглядишь сонной.' },
        { type: 'dialogue', speaker: 'Предрассветная Мгла', mood: 'neutral', text: '— Да вот полночи не спала, тебя вспоминала. Как увижу эту рожу, так любое желание поспать улетучивается.' },
        { type: 'dialogue', speaker: 'Хвойник', mood: 'happy', text: '— Ух ты, кто-то не в духе. Хе-хе, так же лучше для меня! Но дам немножко форы. Советую тебе сегодня не кормить своего дракона — завтра заезд, лучше их держать слегка обозлёнными. Подготовь тогда снаряжение для поездки.' },
        { type: 'dialogue', speaker: 'Предрассветная Мгла', mood: 'neutral', text: '— И долго ты будешь со мной нянчиться? Я в этом деле дольше тебя буду! Сама со снаряжением разберусь. Лишь покажи, где оно выдаётся.' },
        { type: 'jump', to: 'gear_intro' }
    ],
    gear_intro: [
        { type: 'hideChars' }, { type: 'playMusic', file: 'field' },
        { type: 'setBg', bg: 'bg-field' },
        { type: 'showChar', pos: 'right', name: 'nora', mood: 'neutral' },
        { type: 'dialogue', speaker: '', text: 'Хвойник отводит Предрассветную Мглу к небольшому складу. Каждому участнику положено два типа снаряжения: кожаное и металлическое. Он всё осматривает, а затем поворачивается к Предрассветной Мгле.' },
        { type: 'showChar', pos: 'left', name: 'khvoynik', mood: 'neutral' },
        { type: 'dialogue', speaker: 'Хвойник', mood: 'happy', text: '— Знаю, у твоего Тройного удара снаряжение получше, но и тут всё имеет очень даже недурное качество. Что выбрать — решать тебе. Металл, конечно, выглядит прочным, но может помешать манёвренности, а кожа хоть и лёгкая, но от столкновений совсем не защищает. Оставлю это на твою светлую голову.' },
        { type: 'dialogue', speaker: '', text: 'Затем, ухмыльнувшись, он уходит. Предрассветная Мгла ругается ему вслед и обращает свой взор на предложенное снаряжение.' },
        { type: 'hideChars' }, { type: 'showChar', pos: 'right', name: 'nora', mood: 'neutral' },
        { type: 'dialogue', speaker: '', text: 'Она проводит лапой по кожаному седлу. Кожа легко поддаётся нажатию, изгибаясь под весом её усилия. Сверху находится мягкая подушка, набитая перьями — всё для комфорта наездника! Пахнет седло смазочным маслом и древесиной' },
        { type: 'dialogue', speaker: '', text: 'В некоторых местах поверхность покрыта царапинами и потёртостями, значит, оно уже использовалось кем-то до неё. Это хороший знак, потому что новая кожа, как правило, более твёрдая, и на разноску седла требуется некоторое время. А тут всё уже готово!'},
        { type: 'dialogue', speaker: '', text: 'Седло должно крепиться к туловищу дракона кожаными ремешками с железными кольцами. Дырки в ремешках были почти не изношенными, на металле не было видно ржавчины. ' },
        { type: 'dialogue', speaker: '', text: 'Рядом лежала упряжь с поводьями, которая крепилась к седлу. Упряжь была сконструирована так, чтобы она могла принимать форму головы любого дракона без дискомфорта для последнего.'},
        { type: 'dialogue', speaker: '', text: 'На другой стороне склада лежало металлическое снаряжение. Предрассветная Мгла постучала когтем по поверхности боковой брони, она издала приятный гулкий звон.' },
        { type: 'dialogue', speaker: '', text: 'Трудно было сказать, из какого металла всё это сделано. Скорее всего, это были залежи горных пород, закалённые в огне и принявшие свою форму благодаря работе мастера-кузнеца. '},
        { type: 'dialogue', speaker: '', text: 'Броня была пластинчатая, что позволяло ей не так сильно сковывать движения дракона. И всё же она из-за своего веса могла помешать его манёвренности. Броня крепилась к телу при помощи ремешков, защищая наиболее важные участки: голову, шею, спину и бока. ' },
        { type: 'dialogue', speaker: '', text: 'Открытыми оставались лишь брюхо, так как дракон вряд ли подставит его в полёте, и крылья, так как им требуется лёгкость. В остальном броня являлась прекрасным вариантом для наездника, который хочет обеспечить себя и дракона надёжной защитой от возможных столкновений.'},
        { type: 'jump', to: 'gear_choice' }
    ],
    gear_choice: [
        { type: 'hideChars' }, 
        { type: 'action', func: 'showDragonSolo' }, // ТОЛЬКО дракон
        { type: 'dialogue', speaker: '', text: 'Что выбрать?' },
        { type: 'choice', options: [
            { text: 'Легкое кожаное седло', jumpTo: 'gear_result', params: 'saddle' },
            { text: 'Укрепленная чешуйчатая броня', jumpTo: 'gear_result', params: 'armor' },
            { text: 'Аэродинамические закрылки', jumpTo: 'gear_result', params: 'wings' },
            { text: 'Тяжелые шипованные наголенники', jumpTo: 'gear_result', params: 'spikes' }
        ]}
    ],
    gear_result: [
        { type: 'action', func: 'processGear' },
        { type: 'eval', code: `
            if (engine.lastGearChoice === 'saddle') engine.jumpTo('gear_saddle_desc');
            else if (engine.lastGearChoice === 'armor') engine.jumpTo('gear_armor_desc');
            else engine.jumpTo('gear_other_desc');
        `}
    ],
    gear_saddle_desc: [{ type: 'dialogue', speaker: '', text: 'Предрассветная Мгла решила, что нет смысла защищаться от препятствий, если их можно просто облететь! Потому её выбор пал на кожаное снаряжение. Она взвалила его на свои плечи и подошла к дракону. Тот уже всё понял и заранее встал на все четыре лапы.' },
        { type: 'dialogue', speaker: '', text: 'Она долго вертелась возле него, устанавливая седло и закрепляя ремешки. Вот последняя шпилька попала на нужное место, Предрассветная Мгла сильно потянула ремешок на себя, чтобы он смог закрепиться вокруг туловища дракона. '},
        { type: 'dialogue', speaker: '', text: 'Она отряхнула свои лапы от пыли и сделала несколько шагов назад, чтобы увидеть результат. Мягкое кожаное седло было закреплено на спине дракона, упряжь обхватывала верхнюю часть его головы, а поводья были закинуты на рог седла.'},
        { type: 'jump', to: 'gear_reaction' }],
    gear_armor_desc: [{ type: 'dialogue', speaker: '', text: 'Кому нужны полумеры, когда можно обеспечить себя надёжной защитой? Вот и Предрассветная Мгла решила также, таская за собой большие железные пластины. Дракон заранее встал на четыре лапы. Долго она вертелась вокруг него, примеряя пластины и скрепляя их вместе, пока они не стали повторять форму его тела.' },
        { type: 'dialogue', speaker: '', text: 'Она отряхнула свои лапы от пыли и сделала несколько шагов назад, чтобы увидеть результат. Металлическая броня отливала ярким блеском на солнце. Каждое сочленение было туго закреплено, чтобы избежать проблем во время полёта.'},
        { type: 'dialogue', speaker: '', text: 'Металл покрывал спину, бока и часть головы дракона. Упряжь была плотно закреплена на его голове и шее, поводья свисали со спины, седло умещалось на верхушке его спины. Она могла быть уверена, что с такой защитой им не страшны никакие препятствия.'},
        { type: 'jump', to: 'gear_reaction' }],
    gear_other_desc: [{ type: 'dialogue', speaker: '', text: 'Предрассветная Мгла решила попробовать что-то нестандартное. Она внимательно закрепила выбранное снаряжение, проверяя надежность каждого крепления. Дракон терпеливо ждал.' }, { type: 'jump', to: 'gear_reaction' }],
    
    gear_reaction: [
        { type: 'eval', code: `
            const pref = engine.lastGearPref;
            if (pref > 0) { engine.jumpTo('gear_good_react'); }
            else if (pref < 0) { engine.jumpTo('gear_bad_react'); }
            else { engine.jumpTo('day2_end'); }
        `},
    ],
    gear_good_react: [{ type: 'dialogue', speaker: '', text: 'Дракон одобрительно фыркнул. Кажется, ему понравилось это снаряжение.' }, { type: 'jump', to: 'day2_end' }],
    gear_bad_react: [{ type: 'dialogue', speaker: '', text: 'Дракон недовольно зарычал. Ему явно некомфортно в этой амуниции.' }, { type: 'jump', to: 'day2_end' }],
    day2_end: [
        { type: 'hideChars' }, { type: 'showChar', pos: 'right', name: 'nora', mood: 'neutral' }, { type: 'setBg', bg: 'bg-room' }, { type: 'playMusic', file: 'room' }, 
        { type: 'dialogue', speaker: '', text: 'Предрассветная Мгла провозилась почти до самого вечера. Дракон нетерпеливо бил себя хвостом по бокам. Завтра будет важный день, завтра она будет пожинать плоды собственных усилий. Остаётся лишь надеяться, что она сделала правильные выборы. ' },
        { type: 'dialogue', speaker: '', text: 'Эх, дали бы ей возможность полетать на её Свартфаре, она бы всех победила влёгкую!'},
        { type: 'dialogue', speaker: '', text: 'Глаза слипались от усталости. Сейчас бы упасть в мягкие объятия пуховой кровати и накрыться тёплым одеялом… Еле волоча лапы, она подошла к своему спальному месту и легла спать.' },
        { type: 'stopMusic' },
        { type: 'transition', text: 'На следующий день...', to: 'day3_start' }
    ],

    // === ДЕНЬ 3 ===
    day3_start: [
        { type: 'setDay', day: 3 }, { type: 'setBg', bg: 'bg-room' }, { type: 'playMusic', file: 'room' },  { type: 'hideChars' },
        { type: 'dialogue', speaker: '', text: 'Тьма. Опять. Только в этот раз она не спит. Предрассветная Мгла лежит на кровати с открытыми глазами. Сон никак не приходит. Странно, но она… волнуется. Казалось бы, годы опыта, тысячи полётов, многочисленные тренировки, но это всё не помогает. Каждый раз волнуешься, как в первый. ' },
        { type: 'dialogue', speaker: '', text: 'Она решила прогуляться, чтобы отогнать тяжёлые мысли. Луна ярко светила в небе, ветер ласково трепал шерсть на её ушах, а в траве раздавался редкий стрёкот сверчков. Тропинка была холодной под лапами. Предрассветная Мгла глубоко вдохнула. Лёгкие наполнились свежим ночным воздухом. Выдох. Так гораздо спокойнее.' },
        { type: 'setBg', bg: 'bg-field' }, // Ночная прогулка
        { type: 'dialogue', speaker: '', text: 'Пройдя чуть дальше, она увидела большое чешуйчатое существо. Один глаз его был открыт, бока мерно поднимались и опускались, тяжёлое дыхание издавалось из его пасти. Дракон, который по прошествию трёх дней уже абсолютно точно принадлежал ей, упрямо продолжал сверлить её одним глазом.' },
        { type: 'eval', code: `
            if (engine.state.mood >= 1) engine.jumpTo('night_good');
            else if (engine.state.mood <= -1) engine.jumpTo('night_bad');
            else engine.jumpTo('night_neutral');
        `}
    ],
    night_good: [
        { type: 'action', func: 'showDragonAndNora' },
        { type: 'dialogue', speaker: '', text: 'Предрассветной Мгле при виде её дракона сразу стало теплее на душе. Она подошла к нему и осторожно положила лапу на его бок, который продолжал мерно подниматься и опускаться. Дракон покорно закрыл оставшийся глаз.' },
        { type: 'dialogue', speaker: '', text: 'Под её лапой дышало живое существо. Хоть они и не могли переговариваться друг с другом, но между ними было полное взаимопонимание. Конечно, выбор между этим драконом и её Свартом даже не стоит, но, странное дело, она привязалась к этой чешуйчатой туше.'},
        { type: 'dialogue', speaker: '', text: 'Затем Предрассветная Мгла легла рядом с ним, прижавшись спиной к его брюху. Она чувствовала, как оно медленно поднималось и опускалось. Её собственное дыхание само подстроилось под этот ритм. Вдох. Выдох. Вдох. Выдох. Предрассветная Мгла провалилась в глубокий сон.' },
        { type: 'jump', to: 'race_intro' }
    ],
    night_bad: [
        { type: 'action', func: 'showDragonAndNora' },
        { type: 'dialogue', speaker: '', text: 'Она попыталась приблизиться к дракону. Возможно, это была последняя попытка наладить их отношения. Как опытная наездница, она понимала, что доверие — это ключ к успеху. Но когда сделала пару шагов, то услышала из его глотки предупреждающий рокот.' },
        { type: 'dialogue', speaker: '', text: 'Его выражение лица будто говорило, что он позволит себя оседлать лишь из-за крепкой упряжи на своей голове, но пусть она не ждёт к себе хорошего отношения. Они вместе поневоле.' },
        { type: 'dialogue', speaker: '', text: 'Она ещё немного погуляла по тропинкам и вернулась в дом. Матрас привычно скрипнул под её весом. В этот раз сон послушно открыл для неё свои двери — и она не смела ему отказывать.' },
        { type: 'jump', to: 'race_intro' }
    ],
    night_neutral: [
        { type: 'action', func: 'showDragonAndNora' },
        { type: 'dialogue', speaker: '', text: 'Она решила не приближаться к нему. Дракону нужен свой сон, нечего его тревожить. Тот не выказывал к Предрассветной Мгле ни капли враждебности, но по его открытому глазу было видно, что он готов действовать в случае опасности.' },
        { type: 'dialogue', speaker: '', text: ' За три дня им так и не удалось подружиться. Дракон по-прежнему с настороженностью относился к наезднице. Но и врагами они не стали, так что он не спихнёт её прямо в полёте. '},
        { type: 'dialogue', speaker: '', text: 'Она ещё немного погуляла по тропинкам и вернулась в дом. Матрас привычно скрипнул под её весом. В этот раз сон послушно открыл для неё свои двери — и она не смела ему отказывать.' },
        { type: 'jump', to: 'race_intro' }
    ],

    race_intro: [
        { type: 'setBg', bg: 'bg-square' }, { type: 'playMusic', file: 'arena' }, { type: 'hideChars' },
        { type: 'dialogue', speaker: '', text: 'Предрассветная Мгла в последний раз проверила на драконе всё снаряжение. Ремешки были туго затянуты, ничего не болтается, поводья сами просятся в лапы. Она залезла на дракона сверху и села в седло.' },
        { type: 'dialogue', speaker: '', text: 'Оно привычно прогнулось под её весом. Пора выходить. '},
        { type: 'dialogue', speaker: '', text: 'Атмосфера гонок была потрясающей. В небе светило яркое солнце, трибуны зарывались приветственным хором, рог трубил боевые мотивы. ' },
        { type: 'dialogue', speaker: '', text: 'Остальные участники занимались своими делами. Кто-то в сотый раз проверял снаряжение, кто-то трясся от страха, кто-то пил мёд, что явно плохо скажется на его координации. Предрассветная Мгла внешне казалась спокойной, лишь подрагивание её ушей выдавало внутреннее волнение.'},
        { type: 'playSound', file: 'horn' },
        { type: 'dialogue', speaker: '', text: 'Прозвучал первый рог. Драконы вместе с наездниками подошли к линии старта. Краем глаза она увидела Хвойника. Они обменялись короткими кивками. Сейчас не время вести дружеские беседы. Каждый мускул её тела был напряжён. Хвойник, по-видимому, волновался не меньше.' },
        { type: 'playSound', file: 'horn' },
        { type: 'dialogue', speaker: '', text: 'Второй рог. Драконы слегка поджали лапы, а всадники наклонились вперёд. Предрассветная Мгла выдохнула скопившийся воздух и крепче сжала поводья. У неё получится, она обязана выиграть, за её плечами много лет опыта. Время истины.' },
        { type: 'playSound', file: 'horn' },
        { type: 'dialogue', speaker: '', text: 'Третий рог. Драконы ринулись вперёд. Да одержит победу сильнейший!' },
        { type: 'eval', code: `if (engine.state.mood <= -1) engine.jumpTo('race_bad_ending'); else engine.jumpTo('race_start');` }
    ],

    race_bad_ending: [
        { type: 'setBgFunc', func: `engine.state.dragon === 'thunder' ? 'bg-water' : 'bg-sky'` },
        // 1. Останавливаем веселую музыку
        { type: 'stopMusic' },
        { type: 'stopAmbience' },
        
        // 2. Включаем ГРУСТНУЮ музыку
        { type: 'playMusic', file: 'defeat' },
        
        { type: 'playSound', file: 'roar' }, // Злой рык
        { type: 'dialogue', speaker: '', text: 'Её дракон оторвался от земли и понёсся вперёд. Свист и ужас, биение сердца, зашкаливающий адреналин — это то, ради чего стоит жить! ' },
        { type: 'dialogue', speaker: '', text: 'Драконы приблизились к первому повороту. Она впереди всех. Предрассветная Мгла дёрнула поводья, чтобы повернуть влево, но дракон вдруг её не послушался. Он медленно качнулся вправо. Она приложила все свои усилия, чтобы не упасть. Дракон едва слышно фыркнул и перевернулся в полёте.'},
        { type: 'dialogue', speaker: '', text: 'Предрассветная Мгла сорвалась. Она камнем полетела вниз под свист шокированных зрителей. В последнее мгновение она увидела морду своего дракона. Тот смотрел на неё через узкие щёлки глаз с выражением абсолютного презрения' },
        { type: 'dialogue', speaker: '', text: 'Дай ему тысячу попыток — и он каждый раз будет поступать также. Это была холодная, леденящая ненависть. Затем он отвернул голову. Кошка продолжила падать, не успев даже издать крик из-за неожиданности. '},
        { type: 'dialogue', speaker: '', text: 'Вдруг она почувствовала, как её кто-то схватил за лапу. Она открыла глаза. На неё шокированно смотрел Хвойник и глубоко дышал. Одним рывком он закинул её на своё седло позади себя.' },
        { type: 'showChar', pos: 'right', name: 'nora', mood: 'neutral' },
        { type: 'showChar', pos: 'left', name: 'khvoynik', mood: 'neutral' },
        { type: 'dialogue', speaker: 'Хвойник', mood: 'neutral', text: '— Это что вообще было?! Как… В смысле… Почему он сбросил тебя?' },
        { type: 'dialogue', speaker: 'Предрассветная Мгла', mood: 'neutral', text: '— Я… Я не знаю! Чёртов дракон! А я знала, я видела всё это, как он смотрел на меня, словно на протухшую рыбу! Но даже я не могла бы и на секунду представить, что он выкинет такое!' },
        { type: 'dialogue', speaker: 'Хвойник', mood: 'neutral', text: '— Нам стоит вернуться к старту. С этим разберёмся потом. Держись крепче.' },
        { type: 'dialogue', speaker: '', text: 'Через несколько минут они снова были на поверхности. Предрассветная Мгла дрожала от злости. Какое неожиданное и дерзкое предательство! Да как он посмел! Впредь она зареклась никогда больше в подобных турнирах не участвовать, только со своим драконом и точка!' },
        { type: 'end', title: 'ПРЕДАТЕЛЬСТВО', desc: 'Дракон ненавидел вас и сбросил в начале гонки.', win: false, art: 'end_bad_betrayal' }
    ],

    race_start: [
        { type: 'setBgFunc', func: `engine.state.dragon === 'thunder' ? 'bg-water' : 'bg-sky'` },
        { type: 'dialogue', speaker: '', text: 'Её дракон сразу вырвался в лидеры! Свист в ужас, биение сердца, зашкаливающий адреналин — это то, ради чего стоит жить!' },
        { type: 'dialogue', speaker: '', text: 'Первый поворот, второй, третий — они идеально входили в каждый из них. Седло скрипело под ней, поводья натягивались, азарт захлёстывал разум.'},
        { type: 'dialogue', speaker: '', text: 'И вот финишная прямая! Ещё несколько метров — и Предрассветная Мгла станет победительницей в гонке!'},
        { type: 'action', func: 'startMiniGame' }
    ],

    race_win: [
        { type: 'setBg', bg: 'bg-square' }, { type: 'hideChars' },
        // 1. Выключаем шум гонки и крыльев
        { type: 'stopMusic' },
        { type: 'stopAmbience' }, 

        // 2. Сразу громкий РЫК
        { type: 'playSound', file: 'roar' },

        // 3. Включаем ПОБЕДНУЮ музыку
        { type: 'playMusic', file: 'victory' },
        
        { type: 'showChar', pos: 'center', name: 'dragon', mood: 'happy' }, 
        { type: 'showChar', pos: 'right', name: 'nora', mood: 'happy' }, 
        { type: 'showChar', pos: 'left', name: 'khvoynik', mood: 'neutral' },
        { type: 'dialogue', speaker: '', text: 'Трибуны ликовали. Какая гонка, какое напряжение, какой праздник для их народа! Это было настоящее событие, объединяющее под собой всех обитателей острова. Предрассветная Мгла на своём драконе пронеслась возле трибун, подняв лапы в воздух. Болельщики восторженно закричали. Один манёвр — и они уже на поверхности. ' },
        { type: 'dialogue', speaker: '', text: 'Предрассветная Мгла слезла со своего дракона и похлопала его по боку. Он глубоко дышал после пройденной гонки. Она осмотрелась вокруг. Её, стуча лапой по земле от нетерпения, ждал Хвойник. Она подошла к нему и подняла голову. Тот помолчал пару мгновений и вздохнул.' },
        { type: 'dialogue', speaker: 'Хвойник', mood: 'happy', text: '— Да-да, ты самая лучшая, ты снова победила, молодец, может, пойдём уже?' },
        { type: 'dialogue', speaker: 'Предрассветная Мгла', mood: 'happy', text: '— Кое-что забыл! — произнесла она с нескрываемой ухмылкой. — Колечко-то у меня остаётся, ха-ха! Никому не отдам, слышишь? Я не зря столько лет в полётах провела!' },
        { type: 'dialogue', speaker: 'Хвойник', mood: 'neutral', text: '— Чтоб ещё раз я стал с тобой тягаться… — буркнул Хвойник в ответ. — Ладно, там тебя приз ждёт, нам пора идти.' },
        { type: 'dialogue', speaker: 'Предрассветная Мгла', mood: 'happy', text: '— И правда, пора. Это была славная гонка.' },
        { type: 'end', title: 'ПОБЕДА!', desc: 'Вы получили звание лучшего укротителя!', win: true, art: 'end_good' }
    ],

    race_lose: [
        { type: 'stopMusic' },
        { type: 'stopAmbience' },
        { type: 'playMusic', file: 'defeat' }, // Грустная музыка
        { type: 'playSound', file: 'roar' },   // Рык боли/разочарования
        { type: 'end', title: 'КРУШЕНИЕ', desc: 'Вы врезались в слишком много препятствий и не дошли до финиша.', win: false, art: 'end_bad_crash' }
    ]
};